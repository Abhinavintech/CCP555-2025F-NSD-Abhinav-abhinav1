name: Fragments CI

on:
  push:
    paths:
      - 'Labs/fragments/**'
  pull_request:
    paths:
      - 'Labs/fragments/**'

jobs:
  lint-fragments:
    name: Lint Fragments
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install ESLint (pinned)
        working-directory: Labs/fragments
        run: npm install eslint@8.45.0 --no-audit --no-fund --no-package-lock
      - name: Run ESLint
        working-directory: Labs/fragments
        run: npx eslint -c .eslintrc.cjs . --ext .js || true

  test-fragments:
    name: Run Fragments unit tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install dependencies
        working-directory: Labs/fragments
        run: npm ci
      - name: Install Lab3 dependencies (tests/config)
        working-directory: Labs/Lab3
        run: npm ci
      - name: Run tests
        working-directory: Labs/fragments
        env:
          NODE_ENV: test
        run: npm test --silent

  coverage-fragments:
    name: Coverage (Fragments)
    runs-on: ubuntu-latest
    needs: test-fragments
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        working-directory: Labs/fragments
        run: npm ci
      - name: Run coverage
        working-directory: Labs/fragments
        env:
          NODE_ENV: test
        run: npm run coverage --silent
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: fragments-coverage
          path: Labs/fragments/coverage

  # Optional integration job (commented) - run against a real S3 bucket using secrets
  integration-fragments:
    name: Fragments integration (S3)
    runs-on: ubuntu-latest
    if: false # enable manually and supply secrets
    needs: test-fragments
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install deps (allow optional native builds)
        working-directory: Labs/fragments
        run: npm ci
      - name: Run integration smoke (S3)
        working-directory: Labs/fragments
        env:
          NODE_ENV: test
          STORAGE_BACKEND: s3
        run: |
          # Replace with an integration script if present; this is a placeholder
          node ./tests/Integration/smoke.js || echo "No integration script."
